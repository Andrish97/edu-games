<!DOCTYPE html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <title>Reset hasła – Neon Arcade</title>

    <link rel="stylesheet" href="css/theme.css" />
    <link rel="stylesheet" href="css/login.css" />

    <script
      src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"
      defer
    ></script>
    <script src="js/core/auth.js" defer></script>

    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        const statusEl = document.querySelector(".reset-status");
        const errorEl = document.querySelector(".reset-error");
        const formEl = document.querySelector(".reset-form");
        const pass1 = document.querySelector(".reset-pass1");
        const pass2 = document.querySelector(".reset-pass2");
        const btn = document.querySelector(".reset-submit");

        function setStatus(msg) {
          if (statusEl) statusEl.textContent = msg || "";
        }
        function setError(msg) {
          if (errorEl) errorEl.textContent = msg || "";
        }

        // ---- Parsowanie #hash z Supabase ----
        const hash = window.location.hash || "";
        // zamieniamy "#a=b&c=d" na obiekt { a: 'b', c: 'd' }
        const params = {};
        if (hash.startsWith("#")) {
          const q = hash.substring(1);
          q.split("&").forEach((pair) => {
            const [k, v] = pair.split("=");
            if (k) params[decodeURIComponent(k)] = decodeURIComponent(v || "");
          });
        }

        const hasError = !!params.error || !!params.error_code;
        const isExpired =
          params.error_code === "otp_expired" ||
          (params.error_description || "").toLowerCase().includes("expired");
        const isRecovery = params.type === "recovery";

        if (hasError) {
          // link nie działa (np. otp_expired)
          formEl.style.display = "none";
          setStatus(
            "Link do resetu hasła jest nieprawidłowy lub wygasł. Użyj opcji „Przypomnij hasło” ponownie, aby dostać nowy link."
          );
          if (isExpired) {
            setError("Ten link resetujący hasło już wygasł.");
          }
          return;
        }

        if (!isRecovery || !params.access_token) {
          // ktoś wszedł tu ręcznie / bez poprawnego linku Supabase
          formEl.style.display = "none";
          setStatus(
            "Brak poprawnego linku resetującego hasło. Wejdź na tę stronę przez link z e-maila."
          );
          return;
        }

        // Mamy poprawny link recovery – możemy pokazać formularz
        formEl.style.display = "block";
        setStatus("Ustaw nowe hasło do swojego konta.");

        btn.addEventListener("click", async () => {
          setError("");
          const p1 = pass1.value;
          const p2 = pass2.value;

          if (!p1 || !p2) {
            setError("Podaj i powtórz nowe hasło.");
            return;
          }
          if (p1 !== p2) {
            setError("Hasła nie są takie same.");
            return;
          }

          if (!window.supabaseClient) {
            setError("Brak połączenia z serwerem.");
            return;
          }

          try {
            const { data, error } = await window.supabaseClient.auth.updateUser({
              password: p1,
            });
            if (error) {
              console.error("[reset] updateUser error:", error);
              setError(error.message || "Nie udało się zmienić hasła.");
              return;
            }
            setStatus(
              "Hasło zostało zmienione. Możesz teraz zalogować się na stronie logowania."
            );
            formEl.style.display = "none";
          } catch (e) {
            console.error("[reset] unexpected error:", e);
            setError("Nie udało się zmienić hasła. Spróbuj ponownie.");
          }
        });
      });
    </script>
  </head>
  <body class="arcade-body">
    <div class="shell">
      <div class="card">
        <header class="header">
          <div>
            <div class="title">Reset hasła</div>
            <div class="subtitle">
              Ustaw nowe hasło po kliknięciu w link z e-maila.
            </div>
          </div>
        </header>

        <p class="reset-status" style="margin-bottom: 12px">
          Ładuję stan resetu hasła...
        </p>

        <div class="reset-form" style="display:none">
          <input
            type="password"
            class="arcade-input reset-pass1"
            placeholder="Nowe hasło"
          />
          <input
            type="password"
            class="arcade-input reset-pass2"
            placeholder="Powtórz nowe hasło"
          />

          <div style="margin-top: 12px">
            <button class="arcade-btn reset-submit">Zapisz nowe hasło</button>
          </div>

          <div
            class="reset-error"
            style="margin-top: 8px; font-size: 12px; color: #fecaca"
          ></div>

          <p style="margin-top: 16px; font-size: 13px">
            Po zmianie hasła możesz przejść do
            <a href="index.html">strony logowania</a> lub od razu do
            <a href="arcade.html">Neon Arcade</a>.
          </p>
        </div>
      </div>
    </div>
  </body>
</html>
